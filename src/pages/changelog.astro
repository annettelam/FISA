---
// Import necessary components and data
import { getLogsBySchool, getAllSchoolNumbersOrderedByRecentChange } from '../../public/changelog';
import ChangeLogTable from '../components/ChangeLogTable.astro';
import Layout from '../layouts/Layout.astro';

// Extract query parameters for pagination (use default values if not provided)
const params = new URL(Astro.url).searchParams;
const page = parseInt(params.get('page') || '1');

// Fetch all school numbers for pagination, ordered by recent changes
const schoolNumbers = getAllSchoolNumbersOrderedByRecentChange();
const totalPages = schoolNumbers.length; // Total pages equal the number of schools

// Fetch logs for the school corresponding to the current page
const schoolNum = schoolNumbers[page - 1];
const logs = getLogsBySchool(schoolNum);

const title = "School Change Log";
---

<Layout title={title}>
  <div class="max-w-7xl mx-auto mt-10 p-8 bg-white shadow-md rounded-lg">
    <div class="text-center mb-10">
      <h1 class="text-3xl font-bold text-gray-800">School Change Log</h1>
      <p class="text-gray-600">This tracks changes made to school data through a fact sheet by an admin (not a client).</p>
    </div>

    <!-- Render the change log table -->
    <ChangeLogTable logs={logs} schoolNum={schoolNum} />

    <!-- Pagination controls -->
    <div class="mt-6 flex justify-center space-x-2">
      {page > 1 ? (
        <a href={`?page=${page - 1}`} class="px-4 py-2 bg-blue-500 text-white rounded">Previous</a>
      ) : (
        <span class="px-4 py-2 text-gray-400">Previous</span>
      )}

      <!-- Page numbers -->
      {[...Array(totalPages).keys()].map(i => (
        <a href={`?page=${i + 1}`} class={`px-4 py-2 rounded ${i + 1 === page ? 'bg-gray-300 text-white' : 'bg-blue-500 text-white'}`}>
          {i + 1}
        </a>
      ))}

      {page < totalPages ? (
        <a href={`?page=${page + 1}`} class="px-4 py-2 bg-blue-500 text-white rounded">Next</a>
      ) : (
        <span class="px-4 py-2 text-gray-400">Next</span>
      )}
    </div>
  </div>
</Layout>
