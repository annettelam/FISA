---
const url = new URL(Astro.request.url);
const schoolId = url.searchParams.get("schoolId");

// Initialize schoolData
let schoolData = {
    schoolName: "",
    schoolId: "",
    fteEnrolment: 0,
};

// Initialize an error message variable
let errorMessage = "";

// Check if schoolId is provided
if (schoolId) {
    const apiUrl = new URL(
        `/api/data?schoolId=${encodeURIComponent(schoolId)}`,
        Astro.url.origin,
    );
    try {
        const response = await fetch(apiUrl);
        if (response.ok) {
            const data = await response.json();
            if (data && Object.keys(data).length > 0) {
                schoolData = { ...schoolData, ...data };
            } else {
                errorMessage = "No data returned from API.";
            }
        } else {
            errorMessage = `Error fetching school data: ${response.statusText}`;
        }
    } catch (error) {
        errorMessage = `Error fetching school data: ${error.message}`;
    }
} else {
    errorMessage = "No schoolId provided in the URL.";
}
---

<div
    class="max-w-3xl mx-auto mt-10 p-8 bg-white dark:bg-gray-800 shadow-md rounded-lg"
>
    <!-- Display error message if any -->
    {
        errorMessage && (
            <div style="color: red;">
                <p>{errorMessage}</p>
            </div>
        )
    }

    <div class="flex justify-between items-center mb-6">
        <img src="/fisa_logo_small.png" alt="FISA Logo" class="w-32 h-auto" />
        <div class="text-center">
            <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-100">
                Make a Future Fees Invoice (2023-2024)
            </h1>
            <p class="text-sm text-gray-600 dark:text-gray-300">
                Make a Future annual payment for the service period from April
                1, 2023 to March 31, 2024. Please mail your cheque payable to
                FISABC with a copy of this invoice.
            </p>
        </div>
    </div>

    <form id="makeAFutureForm" class="space-y-6">
        <!-- School Information Section -->
        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4">
            School Information
        </h2>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label
                    for="schoolName"
                    class="block text-sm font-medium text-gray-900 dark:text-gray-200"
                >
                    School Name:
                </label>
                <input
                    type="text"
                    id="schoolName"
                    class="bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg block w-full p-3"
                    readonly
                    value={schoolData.schoolName || ""}
                />
            </div>
            <div>
                <label
                    for="schoolId"
                    class="block text-sm font-medium text-gray-900 dark:text-gray-200"
                >
                    School ID:
                </label>
                <input
                    type="text"
                    id="schoolId"
                    class="bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg block w-full p-3"
                    readonly
                    value={schoolData.schoolId || ""}
                />
            </div>
        </div>

        <!-- Enrollment Information -->
        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4">
            Enrollment Information
        </h2>
        <div class="space-y-4">
            <div>
                <label
                    for="fteEnrolment"
                    class="block text-sm font-medium text-gray-900 dark:text-gray-200"
                >
                    A. Total F.T.E. Enrolment:
                </label>
                <input
                    type="number"
                    id="fteEnrolment"
                    class="bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg block w-full p-3"
                    value={schoolData.fteEnrolment || 0}
                    oninput="calculateMakeAFutureFee()"
                />
            </div>
        </div>

        <!-- Fee Calculation Section -->
        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4">
            Fee Calculation
        </h2>
        <div class="space-y-4">
            <div>
                <label
                    for="totalFeeB"
                    class="block text-sm font-medium text-gray-900 dark:text-gray-200"
                >
                    B. Fee ($3.92 per FTE, minimum $300):
                </label>
                <input
                    type="text"
                    id="totalFeeB"
                    class="bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg block w-full p-3"
                    readonly
                    value="0.00"
                />
            </div>
            <div>
                <label
                    for="setupFee"
                    class="block text-sm font-medium text-gray-900 dark:text-gray-200"
                >
                    C. One-time setup fee ($250):
                </label>
                <input
                    type="number"
                    id="setupFee"
                    class="bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg block w-full p-3"
                    readonly
                    value="250"
                />
            </div>
            <div>
                <label
                    for="lateFee"
                    class="block text-sm font-medium text-gray-900 dark:text-gray-200"
                >
                    D. Late on-boarding fee ($100):
                </label>
                <input
                    type="number"
                    id="lateFee"
                    class="bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg block w-full p-3"
                    readonly
                    value="100"
                />
            </div>
            <div>
                <label
                    for="gst"
                    class="block text-sm font-medium text-gray-900 dark:text-gray-200"
                >
                    E. GST (5% on B + C + D):
                </label>
                <input
                    type="text"
                    id="gst"
                    class="bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg block w-full p-3"
                    readonly
                    value="0.00"
                />
            </div>
            <div>
                <label
                    for="finalAmount"
                    class="block text-sm font-medium text-gray-900 dark:text-gray-200"
                >
                    F. Total Fees Due (B + C + D + E):
                </label>
                <input
                    type="text"
                    id="finalAmount"
                    class="bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg block w-full p-3"
                    readonly
                    value="0.00"
                />
            </div>
        </div>

        <!-- Primary Contact Information Section -->
        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4">
            Primary Contact Information
        </h2>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label
                    for="contactName"
                    class="block text-sm font-medium text-gray-900 dark:text-gray-200"
                >
                    Name:
                </label>
                <input
                    type="text"
                    id="contactName"
                    class="bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg block w-full p-3"
                />
            </div>
            <div>
                <label
                    for="contactEmail"
                    class="block text-sm font-medium text-gray-900 dark:text-gray-200"
                >
                    Email:
                </label>
                <input
                    type="email"
                    id="contactEmail"
                    class="bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100 text-sm rounded-lg block w-full p-3"
                />
            </div>
        </div>

        <!-- Submit Button -->
        <button
            type="submit"
            class="w-full text-white bg-blue-600 dark:bg-blue-700 hover:bg-blue-700 dark:hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 dark:focus:ring-blue-900 font-medium rounded-lg text-sm px-5 py-3 mt-4 text-center"
        >
            Submit
        </button>
    </form>

    <script>
        function calculateMakeAFutureFee() {
            const fteEnrolment =
                parseInt(document.getElementById("fteEnrolment").value) || 0;
            const setupFee = 250;
            const lateFee = 100;
            const feePerFTE = 3.92;
            const minFee = 300;

            const fteFee = Math.max(fteEnrolment * feePerFTE, minFee);
            const subtotal = fteFee + setupFee + lateFee;
            const gst = subtotal * 0.05;
            const finalAmount = subtotal + gst;

            document.getElementById("totalFeeB").value = fteFee.toFixed(2);
            document.getElementById("gst").value = gst.toFixed(2);
            document.getElementById("finalAmount").value =
                finalAmount.toFixed(2);
        }

        document.addEventListener("DOMContentLoaded", () => {
            document
                .getElementById("fteEnrolment")
                .addEventListener("input", calculateMakeAFutureFee);
        });
    </script>
</div>
